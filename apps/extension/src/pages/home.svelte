<script lang="ts">
  import { sendMessage } from "webext-bridge/popup";
  import SidebarTab from "$lib/components/sidebar-tab.svelte";
  import { type DragDropState } from "@thisux/sveltednd";
  import {
    ArrowLeftIcon,
    ArrowRightIcon,
    PlusIcon,
    SearchIcon,
    SettingsIcon,
    UserIcon,
    XIcon,
  } from "lucide-svelte";
  import Layout from "$lib/components/layout.svelte";
  import { tabsStore } from "$lib/store/tabs.svelte";
  import SpacePicker from "$lib/components/space-picker.svelte";
  import SpaceEssentials from "$lib/components/space-essentials.svelte";
  import { useRsv } from "@ryuz/rsv";
  import { Gesture } from "@use-gesture/vanilla";
  import { onMount } from "svelte";
  import { matchSorter } from "match-sorter";
  import ViewTitle from "$lib/components/view-title.svelte";
  import colors from "tailwindcss/colors";
  import SpaceColorPicker from "$lib/components/space-color-picker.svelte";
  import pDebounce from "p-debounce";
  import { authClient } from "$lib/auth";
  import clsx from "clsx";

  const router = useRsv();
  let mode = $state<"tabs" | "search" | "editing">("tabs");
  let searchInput = $state<HTMLInputElement>();
  let spaceNameInput = $state<HTMLInputElement>();
  let searchQuery = $state("");
  let wheelElement = $state<HTMLDivElement>();
  let movementX = $state(0);

  function toggleMode() {
    if (mode === "tabs") {
      setTimeout(() => {
        searchInput?.focus();
      }, 1);
      mode = "search";
      return;
    }
    mode = "tabs";
    searchQuery = "";
  }
  function toggleEditing() {
    if (mode === "editing") {
      mode = "tabs";
      return;
    }
    mode = "editing";
    setTimeout(() => {
      spaceNameInput?.focus();
    }, 1);
  }

  const session = authClient.useSession();
  const currentTab = $derived(tabsStore.tabs.find((tab) => tab.active));
  const currentSpaceTitle = $derived(tabsStore.currentSpace?.title);
  const currentSpaceEssentials = $derived(
    tabsStore.essentials?.[currentSpaceTitle ?? ""] ?? [],
  );
  const currentSpaceIndex = $derived(
    tabsStore.groups.findIndex(
      (group) => group.id === tabsStore.currentSpaceId,
    ),
  );
  const user = $derived($session.data?.user);

  const spaceTabs = $derived(
    tabsStore.tabs.filter((tab) => tab.groupId === tabsStore.currentSpaceId),
  );
  const currentTabIndex = $derived(
    spaceTabs.findIndex((tab) => tab.id === currentTab?.id),
  );
  const spaceTabsFiltered = $derived(
    searchQuery
      ? matchSorter(spaceTabs, searchQuery, {
          keys: ["title", "url"],
        })
      : spaceTabs,
  );
  const leftArrowOpacity = $derived(movementX / -32);
  const rightArrowOpacity = $derived(movementX / 32);
  const canGoBack = $derived(currentSpaceIndex > 0);
  const canGoForward = $derived(
    currentSpaceIndex < tabsStore.groups.length - 1,
  );

  function handleDrop(state: DragDropState<{ index: string }>) {
    const { draggedItem, targetContainer } = state;
    const dragIndex = parseInt(draggedItem.index);
    const dropIndex = Number.isFinite(Number(targetContainer))
      ? parseInt(targetContainer!)
      : 0;
    const fromId = spaceTabs[dragIndex].id;
    const toId = spaceTabs[dropIndex].id;
    sendMessage(
      "grinta_swapTabs",
      {
        fromId,
        toId,
      },
      "background",
    );
  }

  async function handleNewTab() {
    await sendMessage(
      "grinta_newTab",
      { groupId: tabsStore.currentSpaceId },
      "background",
    );
  }

  async function searchKeyDown(event: KeyboardEvent) {
    if (event.key === "Escape") {
      mode = "tabs";
      searchQuery = "";
    }
    if (event.key === "Enter") {
      if (spaceTabsFiltered[0]?.id) {
        await sendMessage(
          "grinta_activateTab",
          { tabId: spaceTabsFiltered[0].id },
          "background",
        );
      }
      mode = "tabs";
      searchQuery = "";
    }
  }

  function handleShortcuts(event: KeyboardEvent) {
    const spaceKeys = [
      "Digit1",
      "Digit2",
      "Digit3",
      "Digit4",
      "Digit5",
      "Digit6",
      "Digit7",
      "Digit8",
      "Digit9",
    ];
    if (event.altKey && event.code === "KeyF") {
      return toggleMode();
    }
    if (event.altKey && event.code === "Slash") {
      return router?.navigate("/settings");
    }
    if (event.altKey && spaceKeys.includes(event.code)) {
      const index = parseInt(event.code.replace("Digit", "")) - 1;
      const groupId = tabsStore.groups[index]?.id;
      if (!groupId) return;
      return sendMessage("grinta_activateGroup", { groupId }, "background");
    }
    if (event.altKey && event.code === "ArrowLeft") {
      const lastSpaceId = tabsStore.groups[tabsStore.groups.length - 1]?.id;
      const prevSpaceId = tabsStore.groups[currentSpaceIndex - 1]?.id;
      return sendMessage(
        "grinta_activateGroup",
        { groupId: prevSpaceId ?? lastSpaceId },
        "background",
      );
    }
    if (event.altKey && event.code === "ArrowRight") {
      const firstSpaceId = tabsStore.groups[0]?.id;
      const nextSpaceId = tabsStore.groups[currentSpaceIndex + 1]?.id;
      return sendMessage(
        "grinta_activateGroup",
        { groupId: nextSpaceId ?? firstSpaceId },
        "background",
      );
    }
    if (event.altKey && event.code === "ArrowDown") {
      const firstTabId = spaceTabs[0]?.id;
      const nextTabId = spaceTabs[currentTabIndex + 1]?.id ?? firstTabId;
      if (!nextTabId) return;
      return sendMessage(
        "grinta_activateTab",
        { tabId: nextTabId },
        "background",
      );
    }
    if (event.altKey && event.code === "ArrowUp") {
      const lastTabId = spaceTabs[spaceTabs.length - 1]?.id;
      const prevTabId = spaceTabs[currentTabIndex - 1]?.id ?? lastTabId;
      if (!prevTabId) return;
      return sendMessage(
        "grinta_activateTab",
        { tabId: prevTabId },
        "background",
      );
    }
  }

  function updateGroupTitle(groupId: number, title: string) {
    if (!title) return;
    if (title.length < 1 || title.length > 32) return;
    const group = tabsStore.groups.find((group) => group.id === groupId);
    if (!group) return;
    return sendMessage(
      "grinta_updateGroup",
      { groupId, color: group.color, title },
      "background",
    );
  }

  function nameKeyDown(event: KeyboardEvent) {
    if (event.key === "Escape") {
      spaceNameInput?.blur();
    }
    if (event.key === "Enter") {
      spaceNameInput?.blur();
    }
  }

  function activateGroup(groupId: number) {
    return sendMessage("grinta_activateGroup", { groupId }, "background");
  }

  const debouncedActivateGroup = pDebounce(activateGroup, 80);

  onMount(() => {
    if (!wheelElement) return;
    const gesture = new Gesture(
      wheelElement,
      {
        onWheel: (event) => {
          movementX = event.movement[0];
          if (event.movement[0] > 32) {
            const sanitizedIndex =
              currentSpaceIndex < tabsStore.groups.length - 1
                ? currentSpaceIndex + 1
                : currentSpaceIndex;
            const groupId = tabsStore.groups[sanitizedIndex].id;
            return debouncedActivateGroup(groupId);
          }
          if (event.movement[0] < -32) {
            const sanitizedIndex =
              currentSpaceIndex > 0 ? currentSpaceIndex - 1 : currentSpaceIndex;
            const groupId = tabsStore.groups[sanitizedIndex].id;
            return debouncedActivateGroup(groupId);
          }
        },
        onWheelEnd: () => {
          movementX = 0;
        },
      },
      { wheel: { axis: "x" } },
    );
    document.body.addEventListener("keydown", handleShortcuts);
    return () => {
      gesture.destroy();
      document.body.removeEventListener("keydown", handleShortcuts);
    };
  });
</script>

<Layout>
  {#if currentSpaceTitle}
    <div class="fixed top-0 left-0 right-0 z-10">
      <ViewTitle title={currentSpaceTitle}>
        {#snippet action()}
          {#if tabsStore.currentSpace}
            <SpaceColorPicker space={tabsStore.currentSpace} />
          {/if}
        {/snippet}
        {#snippet titleElement()}
          {#if mode === "tabs"}
            <button
              class="btn btn-sm btn-ghost flex-1 justify-start text-lg"
              onclick={toggleEditing}
            >
              {currentSpaceTitle}
            </button>
          {/if}
          {#if mode === "search"}
            <input
              type="text"
              class="input input-sm w-full"
              bind:value={searchQuery}
              bind:this={searchInput}
              onkeydown={searchKeyDown}
              placeholder="Search..."
            />
          {/if}
          {#if mode === "editing"}
            <input
              type="text"
              bind:this={spaceNameInput}
              class="input input-sm w-full"
              value={currentSpaceTitle}
              onblur={toggleEditing}
              onkeydown={nameKeyDown}
              oninput={(event) => {
                if (!tabsStore.currentSpaceId) return;
                const value = (event.target as HTMLInputElement)?.value ?? "";
                if (!value) return;
                if (value.length < 1 || value.length > 32) return;
                return updateGroupTitle(tabsStore.currentSpaceId, value);
              }}
              placeholder="Space name"
            />
          {/if}
        {/snippet}
        {#snippet addon()}
          {#if mode === "tabs"}
            <button
              class="btn btn-ghost btn-sm btn-square"
              onclick={toggleMode}
            >
              <SearchIcon size={20} />
            </button>
            <a
              class="btn btn-ghost btn-sm btn-square"
              href={user
                ? "https://getgrinta.com/account"
                : "https://getgrinta.com/sign-in"}
              target="_blank"
              rel="noopener noreferrer"
            >
              {#if user}
                <img
                  src={`https://meshy.studio/api/mesh/${user.id}?noise=8&sharpen=1&negate=false&gammaIn=2.1&gammaOut=2.2&brightness=100&saturation=100&hue=0&lightness=0&blur=0`}
                  alt="Avatar"
                  class="w-6 rounded-full"
                />
              {:else}
                <UserIcon size={20} />
              {/if}
            </a>
          {:else if mode === "search"}
            <button
              class="btn btn-ghost btn-sm btn-square"
              onclick={toggleMode}
            >
              <XIcon size={20} />
            </button>
          {/if}
        {/snippet}
      </ViewTitle>
    </div>
  {/if}
  <div class="flex flex-1 flex-col pt-14 p-2">
    <div class="flex flex-col flex-1 relative" bind:this={wheelElement}>
      {#if canGoBack}
        <div
          class="absolute left-0 top-0 bottom-0 w-8 flex items-center justify-center pointer-events-none"
          style="opacity: {leftArrowOpacity};"
        >
          <button class="btn btn-sm btn-square">
            <ArrowLeftIcon size={24} />
          </button>
        </div>
      {/if}
      {#if canGoForward}
        <div
          class="absolute right-0 top-0 bottom-0 w-8 flex items-center justify-center pointer-events-none"
          style="opacity: {rightArrowOpacity};"
        >
          <button class="btn btn-sm btn-square">
            <ArrowRightIcon size={24} />
          </button>
        </div>
      {/if}
      {#if currentSpaceEssentials.length > 0}
        <SpaceEssentials essentials={currentSpaceEssentials} />
      {/if}
      <div class="flex flex-col flex-1 pb-12">
        <button
          class="btn btn-ghost justify-start w-full gap-2 p-2"
          onclick={handleNewTab}
        >
          <PlusIcon size={24} />
          <span class="flex-1 text-left">New Tab</span>
          <kbd class="kbd kbd-sm">⌘T</kbd>
        </button>
        {#each spaceTabsFiltered as tab, index}
          <SidebarTab
            {tab}
            color={tabsStore.currentSpace?.color ?? "blue"}
            draggableConfig={{
              container: index.toString(),
              dragData: { ...tab, index },
              interactive: ["[data-btn-close]", "[data-btn-activate]"],
            }}
            droppableConfig={{
              container: index.toString(),
              callbacks: { onDrop: handleDrop as never },
              attributes: {
                dragOverClass: "scale-105 border-yellow-300/50",
              },
            }}
          />
        {/each}
      </div>
    </div>
  </div>
  <div class="fixed bottom-14 z-10 w-full">
    <SpacePicker />
  </div>
</Layout>
